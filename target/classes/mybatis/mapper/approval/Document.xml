<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.groupware.approval.dao.DocumentDAO">

	<resultMap id="documentResultMap" type="document">
	    <id property="docId" column="doc_id"/>
	    <result property="empId" column="emp_id"/>
	    <result property="docType" column="doc_type"/>
	    <result property="docTitle" column="doc_title"/>
	    <result property="docContent" column="doc_content" jdbcType="CLOB" javaType="string"/>
	    <result property="docRetentionPeriod" column="doc_retention_period"/>
	    <result property="docWriteDate" column="doc_write_date"/>
	    <result property="docReportDate" column="doc_report_date"/>
	    <result property="docCompleteDate" column="doc_complete_date"/>
	    <result property="docState" column="doc_state"/>
	    <result property="docReadYn" column="doc_read_yn"/>
	    <result property="docTempYn" column="doc_temp_yn"/>
	    <result property="docAprvStep" column="doc_aprv_step"/>
	    <association column="emp_name" property="employee" javaType="employee">
	    	<result column="emp_name" property="empName"/>
	    </association>
	</resultMap>

    <select id="getDocumentById" parameterType="string" resultMap="documentResultMap">
        SELECT
            doc_id, emp_id, doc_type, doc_title, doc_content,
            doc_retention_period, doc_write_date, doc_report_date,
            doc_complete_date, doc_state, doc_read_yn,
            doc_temp_yn, doc_aprv_step
        FROM documents
        WHERE doc_id = #{docId}
    </select>

    <insert id="insertDocument" parameterType="document">
        INSERT INTO documents (
            doc_id, emp_id, doc_type, doc_title, doc_content,
            doc_retention_period, doc_write_date, doc_report_date,
            doc_complete_date, doc_state, doc_read_yn,
            doc_temp_yn, doc_aprv_step
        )
        VALUES (
            #{docId}, #{empId}, #{docType}, #{docTitle}, #{docContent},
            #{docRetentionPeriod}, #{docWriteDate}, #{docReportDate},
            #{docCompleteDate}, #{docState}, #{docReadYn},
            #{docTempYn}, #{docAprvStep}
        )
    </insert>

    <update id="updateDocument" parameterType="document">
        UPDATE documents SET
            emp_id = #{empId}, doc_type = #{docType},
            doc_title = #{docTitle}, doc_content = #{docContent},
            doc_retention_period = #{docRetentionPeriod},
            doc_write_date = #{docWriteDate},
            doc_report_date = #{docReportDate},
            doc_complete_date = #{docCompleteDate},
            doc_state = #{docState},
            doc_read_yn = #{docReadYn} ,
            doc_temp_yn = #{docTempYn},
            doc_aprv_step = #{docAprvStep}
		WHERE doc_id = #{docId}
	</update>
	
	<delete id="deleteDocument" parameterType="string">
		DELETE FROM documents WHERE doc_id = #{docId}
	</delete>
	    
    <insert id="insertDraft" parameterType="document">
        INSERT INTO documents (
            doc_id, emp_id, doc_type, doc_title, doc_content,
            doc_retention_period, doc_write_date, doc_report_date, doc_state,
            doc_read_yn, doc_temp_yn, doc_aprv_step
        )
        VALUES (
            #{docId}, #{empId}, #{docType}, #{docTitle}, #{docContent},
            #{docRetentionPeriod}, #{docWriteDate}, SYSDATE, #{docState},
            default, #{docTempYn}, default
        )
    </insert>
    
    <select id="getDraftDocumentCount" resultType="int" parameterType="string">
        SELECT count(*) 
        FROM documents 
        WHERE emp_id = #{empId} and doc_temp_yn = 'N'
    </select>
    
    <select id="getDraftDocumentList" resultMap="documentResultMap">
    <![CDATA[
        SELECT
            doc_id, emp_id, doc_type, doc_title, doc_report_date,
            doc_complete_date, doc_state, doc_read_yn
        FROM (
        	SELECT
        		rownum as rnum, doc_id, emp_id, doc_type, doc_title, doc_report_date,
        		doc_complete_date, doc_state, doc_read_yn
        	FROM documents
        	WHERE emp_id = #{empId} and doc_temp_yn = 'N' and 
        	rownum <= #{pager.rowsPerPage} * #{pager.pageNo}
        )
        WHERE rnum > (#{pager.rowsPerPage} * (#{pager.pageNo} - 1))
    ]]>
    </select>
    
    <select id="getPendedDocumentCount" resultType="int" parameterType="string">
        SELECT count(*) 
		FROM documents doc, approval_lines apl
		WHERE apl.emp_id = #{empId} AND doc.doc_id = apl.doc_id AND doc.doc_aprv_step = apl.aprv_line_order and doc_temp_yn = 'N'
    </select>
    
    <select id="getPendedDocumentList" resultMap="documentResultMap">
    <![CDATA[
        SELECT
            doc_id, emp_id, emp_name, doc_type, doc_title, doc_report_date,
            doc_complete_date, doc_state, doc_read_yn
        FROM (
        	SELECT
        		rownum as rnum, apl.doc_id, apl.emp_id, emp.emp_name, doc_type, doc_title, doc_report_date,
        		doc_complete_date, doc_state, doc_read_yn
        	FROM documents doc, approval_lines apl, employees emp
        	WHERE apl.emp_id = #{empId} AND doc.doc_id = apl.doc_id AND doc.doc_aprv_step = apl.aprv_line_order AND doc_temp_yn = 'N' AND emp.emp_id = doc.emp_id AND 
        	rownum <= #{pager.rowsPerPage} * #{pager.pageNo}
        )
        WHERE rnum > (#{pager.rowsPerPage} * (#{pager.pageNo} - 1))
    ]]>
    </select>
    
    <update id="updateDocumentReadState" parameterType="document">
    	UPDATE documents SET
    		doc_read_yn = #{docReadYn}
    	WHERE doc_id = #{docId}
    </update>
</mapper>