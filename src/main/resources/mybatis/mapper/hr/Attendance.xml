<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.groupware.hr.dao.AttendanceDAO">

	<resultMap id="attendanceResultMap" type="attendance">
		<result column="atd_id" property="atdId"/>
		<result column="emp_id" property="empId"/>
		<result column="atd_in_time" property="atdInTime"/>
		<result column="atd_out_time" property="atdOutTime"/>
		<result column="atd_state" property="atdState"/>
	</resultMap>
	
	<select id="getAttendanceToday" resultMap="attendanceResultMap">
		SELECT 
		  atd_id, 
		  emp_id, 
		  atd_in_time, 
		  atd_out_time, 
		  atd_state 
		FROM attendances 
		WHERE emp_id = #{empId} AND 
			  to_char(atd_in_time, 'yyyy-MM-DD') = to_char(#{now}, 'yyyy-MM-DD') 
	</select>

	<insert id="insertAttendance">
		<selectKey keyProperty="atdId" resultType="int" order="BEFORE">
        	select seq_atd_id.nextval from dual
    	</selectKey>
		INSERT INTO attendances (
		  atd_id,
		  emp_id,
		  atd_in_time
		) VALUES (
		  #{atdId},
		  #{empId},
		  sysdate
		)
	</insert>
	
	<update id="updateAttendance" parameterType="attendance">
		UPDATE 
			attendances
		SET
		  atd_out_time = #{atdOutTime}
		WHERE emp_id = #{empId} AND 
			  to_char(atd_in_time, 'yyyy-MM-DD') = to_char(#{now}, 'yyyy-MM-DD')
	</update>
	
	<delete id="deleteAttendance">
		DELETE FROM project3.attendances
		WHERE atd_id = #{atdId} AND emp_id = #{empId}
	</delete>

</mapper>