<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.groupware.employee.dao.EmployeeDAO">

	<resultMap id="employeeResultMap" type="employee">
		<result column="emp_id" property="empId"/>
		<result column="pos_id" property="posId"/>
		<result column="dep_id" property="depId"/>
		<result column="emp_mail" property="empMail"/>
		<result column="emp_name" property="empName"/>
		<result column="emp_password" property="empPassword"/>
		<result column="emp_extension_number" property="empExtensionNumber"/>
		<result column="emp_phone_number" property="empPhoneNumber"/>
		<result column="emp_leave_reserve" property="empLeaveReserve"/>
		<result column="emp_substitue_reserve" property="empSubstitueReserve"/>
		<result column="emp_login_failures_cnt" property="empLoginFailuresCnt"/>
		<result column="emp_file_data" property="empFileData"/>
		<result column="emp_file_type" property="empFileType"/>
		<result column="role_name" property="roleName"/>
		<result column="emp_enabled" property="empEnabled"/>
	</resultMap>

	<select id="getEmployeeById" parameterType="string" resultMap="employeeResultMap">
		SELECT emp_id, pos_id, e.dep_id, emp_mail, emp_name, emp_password,
            emp_extension_number, emp_phone_number, emp_leave_reserve,
            emp_substitue_reserve, emp_login_failures_cnt, emp_file_data, emp_file_type, r.role_name, emp_enabled
        FROM employees e, roles r, departments d
        WHERE emp_id = #{empId} and d.dep_id=e.dep_id and d.role_id=r.role_id
	</select>
	
	<update id="updateLoginFailCnt" parameterType="employee">
		update employees
		set emp_login_failures_cnt = #{empLoginFailuresCnt}
		where emp_id = #{empId}
	</update>
	
	<update id="updateLoginSuccessCnt" parameterType="employee">
		update employees
		set emp_login_failures_cnt = #{empLoginFailuresCnt}
		where emp_id = #{empId}
	</update>
	
	<select id="getPhoneNumber" resultType="string">
		select emp_phone_number
		from employees
	</select>
	
	<select id="getTelNumber" resultType="string">
		select DEP_PHONE_NUMBER
		from departments
	</select>
	
	<select id="getMailId" resultType="string">
		select emp_mail
		from employees
	</select>
	
	<select id="getEmpId" parameterType="string" resultType="string">
		select emp_id
		from employees
		where emp_id= #{completeId}%
	</select>
	
	<select id="getLeaveReserve" parameterType="int">
		select pos_lev_cnt
		from positions
		where pos_id = #{posId}
	</select>
	
    <insert id="insertEmployee" parameterType="employee"  useGeneratedKeys="true" keyProperty="empId" keyColumn="emp_id">
        INSERT INTO employees (
            emp_id, pos_id, dep_id, emp_mail, emp_name, emp_password,
            emp_extension_number, emp_phone_number, emp_leave_reserve,
            emp_substitue_reserve, emp_login_failures_cnt, emp_file_data,
            emp_file_type, emp_enabled
        ) VALUES (
            #{empId}, #{posId}, #{depId}, #{empMail}, #{empName},
            #{empPassword}, #{empExtensionNumber}, #{empPhoneNumber},
            #{empLeaveReserve}, default,
            default, #{empFileData,jdbcType=BLOB},
            #{empFileType}, default
        )
    </insert>

	<insert id="insertEmployeeDetail" parameterType="employeeDetail">
		insert into employees(
			emp_id, emp_detail_gender, emp_detail_birthday, emp_detail_workplace,
			emp_married_yn, emp_detail_employment_date, emp_detail_education, 
			emp_detail_employment_state,emp_detail_military_service_yn, 
			emp_detail_major
		) values (
			#{empId}, #{empDetailGender}, #{empDetailBirthday}, #{empDetailWorkplace},
			#{empDetailMarriedYN}, #{empDetailEmploymentDate}, #{empDetailEducation},
			default, #{empDetailMilitaryServiceYN}, #{empDetailMajor}
		)
	</insert>
    <update id="updateEmployee" parameterType="employee">
        UPDATE project3.employees SET
            pos_id = #{posId},
            dep_id = #{depId},
            emp_mail = #{empMail},
            emp_name = #{empName},
            emp_password = #{empPassword},
            emp_extension_number = #{empExtensionNumber},
            emp_phone_number = #{empPhoneNumber},
            emp_leave_reserve = #{empLeaveReserve},
            emp_substitue_reserve = #{empSubstitueReserve},
            emp_login_failures_cnt = #{empLoginFailuresCnt},
            emp_file_data = #{empFileData,jdbcType=BLOB},
            emp_file_type = #{empFileType}
        WHERE emp_id = #{empId}
    </update>

    <delete id="deleteEmployee" parameterType="String">
        DELETE FROM project3.employees WHERE emp_id = #{empId}
    </delete>
    
	
	
</mapper>